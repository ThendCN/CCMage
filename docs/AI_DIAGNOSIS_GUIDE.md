# 🩺 AI 诊断功能指南

## 📋 功能概述

AI 诊断功能可以自动分析项目启动失败的原因,并提供具体的解决方案。当项目启动失败时,系统会收集错误日志并让 AI 进行智能分析。

## ✨ 功能特点

1. **自动错误检测** - 识别启动日志中的错误信息
2. **智能诊断** - 使用 AI 分析根本原因
3. **解决方案推荐** - 提供具体可操作的修复步骤
4. **一键诊断** - 只需点击"AI诊断"按钮

## 🚀 使用方法

### 步骤 1: 启动项目失败

当你尝试启动一个项目但失败时:

1. 项目卡片会显示错误消息
2. 错误详情会自动保存
3. "查看详情"按钮会出现

### 步骤 2: 触发 AI 诊断

在项目卡片上:

1. 点击 **"AI诊断"** 按钮 (红色医疗图标 🩺)
2. 系统会自动收集错误日志
3. AI 对话框会自动打开

### 步骤 3: 查看诊断结果

AI 会提供完整的诊断报告,包括:

- **🔍 问题诊断** - 识别根本原因
- **💡 解决方案** - 具体的修复步骤
- **⚠️ 注意事项** - 重要提示
- **🛡️ 预防措施** - 避免类似问题

### 步骤 4: 执行修复方案

根据 AI 提供的解决方案:

1. 按照步骤执行命令
2. 修改配置或代码
3. 重新启动项目验证

## 📊 诊断信息包含

AI 诊断会分析以下信息:

1. **错误日志** - stderr 和包含错误关键词的日志
2. **启动命令** - 使用的启动命令
3. **项目信息** - 项目路径、技术栈
4. **退出码** - 进程退出状态码(如果有)
5. **完整日志** - 最后 50 条日志(用于上下文)

## 🎯 典型诊断场景

### 场景 1: 端口被占用

**错误日志:**
```
Error: listen EADDRINUSE: address already in use :::3000
```

**AI 诊断会提供:**
- 检查占用端口的进程
- 终止进程或更换端口的方法
- 端口冲突预防建议

### 场景 2: 依赖缺失

**错误日志:**
```
Error: Cannot find module 'express'
```

**AI 诊断会提供:**
- 安装依赖的命令
- 检查 package.json 的建议
- 依赖管理最佳实践

### 场景 3: 配置错误

**错误日志:**
```
SyntaxError: Unexpected token in JSON at position 42
```

**AI 诊断会提供:**
- 定位配置文件错误
- JSON 格式修复方法
- 配置验证工具推荐

### 场景 4: 代码语法错误

**错误日志:**
```
SyntaxError: Unexpected token '}'
```

**AI 诊断会提供:**
- 定位代码错误位置
- 语法修复建议
- 代码检查工具推荐

## 💡 最佳实践

### 1. 及时诊断

启动失败后立即使用诊断功能,日志信息最完整。

### 2. 保存诊断结果

AI 诊断结果会保存在对话历史中,可以随时查看。

### 3. 验证修复

执行修复方案后,重新启动项目验证是否解决。

### 4. 反馈问题

如果 AI 诊断不准确,可以在对话中继续提问或提供更多信息。

## 🔧 技术细节

### 错误日志过滤规则

系统会自动识别以下类型的错误:

- `stderr` 输出的所有内容
- 包含关键词的日志:
  - `error` / `Error`
  - `fail` / `Failed`
  - `exception` / `Exception`
  - `错误`
  - `失败`

### 诊断 Prompt 模板

AI 诊断使用精心设计的 prompt 模板:

```markdown
# 项目启动失败诊断

## 📋 项目信息
- 项目名称、路径、技术栈
- 启动命令、失败状态、退出码

## ❌ 错误日志
[过滤后的错误日志]

## 📝 完整日志
[最后 50 条日志]

## 🎯 诊断任务
1. 问题诊断
2. 解决方案
3. 预防措施
```

### API 接口

**诊断接口:**
```
POST /api/projects/:name/diagnose
Body: { engine: "claude-code" }
```

**响应:**
```json
{
  "success": true,
  "sessionId": "claude-code-diagnose-project-xxx",
  "conversationId": "diagnose-project-xxx",
  "failedInfo": {
    "status": "failed",
    "command": "npm start",
    "errorCount": 5,
    "exitCode": 1
  }
}
```

**SSE 流输出:**
```
GET /api/projects/:name/ai/stream/:sessionId
```

## 🐛 故障排查

### 问题 1: "AI诊断" 按钮不显示

**原因:** 只有在有错误详情时才显示诊断按钮

**解决:**
1. 确保项目启动失败
2. 查看是否有"查看详情"按钮
3. 检查控制台是否有错误日志

### 问题 2: 诊断提示"没有失败记录"

**原因:** 进程管理器中没有保存失败日志

**解决:**
1. 重新启动项目并让其失败
2. 等待几秒让日志收集完成
3. 再次尝试诊断

### 问题 3: AI 诊断没有响应

**原因:** AI 引擎配置或网络问题

**解决:**
1. 检查 `.env` 中的 `ANTHROPIC_API_KEY`
2. 检查网络连接
3. 查看后端日志获取详细错误信息

## 📚 相关文档

- [AI 项目创建调试指南](./AI_DEBUG_GUIDE.md)
- [架构文档](./ARCHITECTURE.md)
- [项目管理指南](./PROJECT_MANAGEMENT_GUIDE.md)

## 🎉 示例

### 完整诊断流程示例

```bash
# 1. 启动项目失败
用户: 点击 "启动" 按钮
系统: ❌ 启动失败 - Error: listen EADDRINUSE :::3000

# 2. 触发诊断
用户: 点击 "AI诊断" 按钮
系统: ✅ AI 诊断已启动 - 检测到 3 个错误

# 3. AI 分析
AI: 🔍 问题诊断
    端口 3000 已被其他进程占用

    💡 解决方案

    方案 1: 终止占用进程
    ```bash
    lsof -i :3000
    kill -9 <PID>
    ```

    方案 2: 更换端口
    ```bash
    PORT=3001 npm start
    ```

# 4. 执行修复
用户: 执行 lsof 和 kill 命令
用户: 重新启动项目
系统: ✅ 项目启动成功
```

---

**更新时间**: 2025-11-30
**版本**: v1.2.1
**功能状态**: ✅ 已实现
